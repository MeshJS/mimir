---
title: "Staking Transactions"
description: "Transactions for delegating ADA and managing stakepools"
icon: ArrowsPointingInIcon
---

In the code snippet, you will find `txBuilder`, which is an instance of `MeshTxBuilder`, with powerful low-level APIs that allow you to build transactions. Here's how to initialize **MeshTxBuilder**.

```tsx
const txBuilder = new MeshTxBuilder({
  fetcher: provider, // get a provider https://meshjs.dev/providers
  verbose: true,
});
```

## Register Stake Address

Same as Transaction, with `MeshTxBuilder`, you have to register a stake address before delegating to stakepools. Here are the 2 APIs you need:

```tsx
txBuilder
  .registerStakeCertificate(rewardAddress)
  .delegateStakeCertificate(rewardAddress, poolIdHash)
```

Since we need to provide the deserialize hash of pool ID, we can use the following util to get it:

```tsx
const poolIdHash = deserializePoolId(
  "pool107k26e3wrqxwghju2py40ngngx2qcu48ppeg7lk0cm35jl2aenx",
);
```

<Card>
  ### Register Stake Address [!toc]

  Register a stake address before delegating to a stakepool.

  **Pool ID**
  `pool107k26e3wrqxwghju2py40ngngx2qcu48ppeg7lk0cm35jl2aenx`

  ```tsx
  const utxos = await wallet.getUtxos();
  const address = await wallet.getChangeAddress();
  const addresses = await wallet.getRewardAddresses();
  const rewardAddress = addresses[0]!;
  const poolIdHash = deserializePoolId("pool107k26e3wrqxwghju2py40ngngx2qcu48ppeg7lk0cm35jl2aenx");

  if (rewardAddress === undefined) {
    throw "No address found";
  }

  const txBuilder = new MeshTxBuilder({
    fetcher: provider, // get a provider https://meshjs.dev/providers
    verbose: true,
  });

  const unsignedTx = await txBuilder
    .registerStakeCertificate(rewardAddress)
    .delegateStakeCertificate(rewardAddress, poolIdHash)
    .selectUtxosFrom(utxos)
    .changeAddress(address)
    .complete();

  const signedTx = await wallet.signTx(unsignedTx);
  const txHash = await wallet.submitTx(signedTx);
  ```
</Card>


## Delegate Stake

Stake delegation with `MeshTxBuilder` is the same as the first delegate, but without registering the stake key, so only one API call is needed:

```tsx
txBuilder
  .delegateStakeCertificate(rewardAddress, poolIdHash)
```

<Card>
  ### Delegate Stake [!toc]

  Delegate stake to a stake pool

  **Pool ID**
  `pool107k26e3wrqxwghju2py40ngngx2qcu48ppeg7lk0cm35jl2aenx`

  ```tsx
  const utxos = await wallet.getUtxos();
  const address = await wallet.getChangeAddress();
  const addresses = await wallet.getRewardAddresses();
  const rewardAddress = addresses[0]!;
  const poolIdHash = deserializePoolId("pool107k26e3wrqxwghju2py40ngngx2qcu48ppeg7lk0cm35jl2aenx");

  if (rewardAddress === undefined) {
    throw "No address found";
  }

  const txBuilder = new MeshTxBuilder({
    fetcher: provider, // get a provider https://meshjs.dev/providers
    verbose: true,
  });

  const unsignedTx = await txBuilder
    .delegateStakeCertificate(rewardAddress, poolIdHash)
    .selectUtxosFrom(utxos)
    .changeAddress(address)
    .complete();

  const signedTx = await wallet.signTx(unsignedTx);
  const txHash = await wallet.submitTx(signedTx);
  ```
</Card>


## Withdraw Rewards

Use MeshTxBuilderâ€™s withdrawal method to specify the reward address and amount.

- rewardAddress (string) - the reward address to withdraw from
- lovelace (number) - the amount to withdraw in Lovelace

```tsx
txBuilder
  .withdrawal(rewardAddress, lovelace)
```

<Card>
  ### Withdraw Rewards [!toc]

  Withdraw staking rewards.

  **Amount in lovelace:** `1000000`

  ```tsx
  const utxos = await wallet.getUtxos();
  const address = await wallet.getChangeAddress();
  const addresses = await wallet.getRewardAddresses();
  const rewardAddress = addresses[0]!;

  if (rewardAddress === undefined) {
    throw "No address found";
  }

  const txBuilder = new MeshTxBuilder({
    fetcher: provider, // get a provider https://meshjs.dev/providers
    verbose: true,
  });

  const unsignedTx = await txBuilder
    .withdrawal(rewardAddress, "1000000")
    .selectUtxosFrom(utxos)
    .changeAddress(address)
    .complete();

  const signedTx = await wallet.signTx(unsignedTx);
  const txHash = await wallet.submitTx(signedTx);
  ```
</Card>


## Deregister Stake

To deregister a stake address with MeshTxBuilder, use the following method:

- rewardAddress (string) - the bech32 reward address to deregister

```tsx
txBuilder
  .deregisterStakeCertificate(rewardAddress: string)
```

<Card>
  ### Deregister Stake [!toc]

  Deregister a stake address.

  ```tsx
  const utxos = await wallet.getUtxos();
  const address = await wallet.getChangeAddress();
  const addresses = await wallet.getRewardAddresses();
  const rewardAddress = addresses[0]!;

  if (rewardAddress === undefined) {
    throw "No address found";
  }

  const txBuilder = new MeshTxBuilder({
    fetcher: provider, // get a provider https://meshjs.dev/providers
    verbose: true,
  });

  const unsignedTx = await txBuilder
    .deregisterStakeCertificate(rewardAddress)
    .selectUtxosFrom(utxos)
    .changeAddress(address)
    .complete();

  const signedTx = await wallet.signTx(unsignedTx);
  const txHash = await wallet.submitTx(signedTx);
  ```
</Card>


## Script Withdrawal - Supporting Withdraw Zero

Withdrawal from a script is supported by `MeshTxBuilder` with this set of APIs:

```tsx
txBuilder
   .withdrawalPlutusScriptV2()
   .withdrawal(rewardAddress, withdrawalAmount)
   .withdrawalScript(stakeScriptCbor)
   .withdrawalRedeemerValue(redeemer)
```

**Withdraw Zero**

This is a technique commonly used on Cardano to prove control of a stake key without actually withdrawing any rewards from its withdrawal account. To perform a "withdraw zero", you have to follow these steps:

- Register script stake key

```tsx
txBuilder
  .registerStakeCertificate(stakeScriptHash)
```

- Withdraw Zero

```tsx
txBuilder
  .withdrawalPlutusScriptV2()
  .withdrawal(rewardAddress, "0")
  .withdrawalScript(stakeScriptCbor)
  .withdrawalRedeemerValue(redeemer)
```

<Card>
  ### Register Script Stake Key [!toc]

  One off setup before triggering withdraw zero

  ```tsx
  const utxos = await wallet.getUtxos();
  const address = await wallet.getChangeAddress();
  const txBuilder = getTxBuilder();
  const stakeScriptCbor = alwaysSucceedMintingStakingScriptCbor(
    deserializeAddress(address).pubKeyHash,
  );

  const txBuilder = new MeshTxBuilder({
    fetcher: provider, // get a provider https://meshjs.dev/providers
    verbose: true,
  });

  const unsignedTx = await txBuilder
    .registerStakeCertificate(resolveScriptHash(stakeScriptCbor, "V2"))
    .selectUtxosFrom(utxos)
    .changeAddress(address)
    .complete();

  const signedTx = await wallet.signTx(unsignedTx, true);
  const txHash = await wallet.submitTx(signedTx);
  ```
</Card>

<br />

<Card>
  ### Withdraw Zero [!toc]

  Actual withdrawal of zero to trigger script validation

  ```tsx
  const utxos = await wallet.getUtxos();
  const collateral = await wallet.getCollateral();
  const address = await wallet.getChangeAddress();
  const stakeScriptCbor = alwaysSucceedMintingStakingScriptCbor(
    deserializeAddress(address).pubKeyHash,
  );
  const rewardAddress = serializeRewardAddress(
    resolveScriptHash(stakeScriptCbor, "V2"),
    true,
    0,
  );

  const txBuilder = new MeshTxBuilder({
    fetcher: provider, // get a provider https://meshjs.dev/providers
    verbose: true,
  });

  const unsignedTx = await txBuilder
    .withdrawalPlutusScriptV2()
    .withdrawal(rewardAddress, "0")
    .withdrawalScript(stakeScriptCbor)
    .withdrawalRedeemerValue("")
    .selectUtxosFrom(utxos)
    .changeAddress(address)
    .txInCollateral(...utxoToTxIn(collateral[0]!))
    .complete();

  const signedTx = await wallet.signTx(unsignedTx, true);
  const txHash = await wallet.submitTx(signedTx);
  ```
</Card>
